---
version: '3'

tasks:
  all:
    cmds:
      - task: :npm:build:all
      - task: :npm:test:unit
      - task: report

  check:
    deps:
      - :common:node:dependencies:local
      - :install:npm:nyc
    cmds:
      - '{{.NPM_BINARY_HANDLE}}nyc report'
      - '{{.NPM_BINARY_HANDLE}}nyc check-coverage --lines 100 --functions 100 --branches 100'

  html:
    deps:
      - :common:node:dependencies:local
      - :install:npm:nyc
    cmds:
      - '{{.NPM_BINARY_HANDLE}}nyc report --reporter=html'

  lcov:
    deps:
      - :common:node:dependencies:local
      - :install:npm:nyc
    cmds:
      - '{{.NPM_BINARY_HANDLE}}nyc report --reporter=lcov'

  open:
    deps:
      - html
      - :npm:install:open-cli
    desc: Ensures the code coverage report is generated and opens it in a browser
    cmds:
      - '{{.NPM_BINARY_HANDLE}}open-cli coverage/index.html'

  report:
    deps:
      - html
      - lcov

  upload:
    deps:
      - lcov
      - :install:npm:codecov
    desc: Uploads code coverage report to `codecov.io`
    cmds:
      - '{{.NPM_BINARY_HANDLE}}codecov'
