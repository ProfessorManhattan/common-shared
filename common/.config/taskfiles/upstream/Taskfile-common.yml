---
version: '3'

vars:
  DOCS_URL: https://gitlab.com/megabyte-labs/documentation/{{.REPOSITORY_SUBTYPE}}
  SHARED_COMMON_URL: https://gitlab.com/megabyte-labs/common/shared.git
  SHARED_FOLDER: .shared

tasks:
  clone:
    cmds:
      - task: clone:common
      - task: clone:docs

  clone:common:
    cmds:
      - rm -rf {{.SHARED_FOLDER}}
      - git clone {{.SHARED_COMMON_URL}} {{.SHARED_FOLDER}}

  clone:docs:
    cmds:
      - rm -rf common/.config/docs
      - git clone {{.DOCS_URL}} {{.SHARED_FOLDER}}/common/.config/docs
      - rm -rf common/.config/docs/.git

  copy:
    deps:
      - copy:common
      - copy:project

  copy:common:
    cmds:
      - cp -rT {{.SHARED_FOLDER}}/common .
      - task: :common:husky:permissions

  copy:project:
    cmds:
      - cp -rT {{.SHARED_FOLDER}}/common common
      - if [ ! -d project ]; then mkdir project; fi
      - cp -rT project common

  merge-and-template:
    deps:
      - merge
      - template

  merge:
    deps:
      - merge:package
      - merge:variables

  merge:package:
    cmds:
      - task: merge:package:project
      - task: merge:package:project-subtype

  merge:package:project:
    deps:
      - :install:software:jq
    cmds:
      - |
        if [ -f "project/package.json.handlebars" ]; then
          jq -s '.[0] * .[1]' {{.SHARED_FOLDER}}/common/package.json.handlebars project/package.json.handlebars > common/package.json.handlebars
        fi

  merge:package:project-subtype:
    deps:
      - :install:software:jq
    cmds:
      - |
        for FOLDER in project-*/; do
          SUBTYPE="$(echo "$FOLDER" | sed 's/files-\(.*\)\//\1/')"
          if [ -f "project-$SUBTYPE/package.json.handlebars" ]; then
            mkdir -p "common-$SUBTYPE"
            jq -s '.[0] * .[1]' common/package.json.handlebars "project-$SUBTYPE/package.json.handlebars" > "common-$SUBTYPE/package.json.handlebars"
          fi
        done

  merge:variables:
    cmds:
      - task: merge:variables:project
      - task: merge:variables:project-subtype

  merge:variables:project:
    deps:
      - :install:software:jq
    cmds:
      - |
        if [ -f "project/.config/variables.json" ]; then
          jq -s -S '.[0] * .[1]' "common/.config/docs/variables.json" "project/.config/variables.json" > "common/.config/variables.json"
        fi

  merge:variables:project-subtype:
    deps:
      - :install:software:jq
    env:
      TMP:
        sh: mktemp
    cmds:
      - |
        for FOLDER in project-*/; do
          SUBTYPE="$(echo "$FOLDER" | sed 's/files-\(.*\)\//\1/')"
          if [ -f "project-$SUBTYPE/.config/variables.json" ]; then
            mkdir -p "common-$SUBTYPE/.config"
            jq --arg subtype "$SUBTYPE" '.subgroup = $subtype' common/.config/variables.json > "$TMP"
            jq -s -S '.[0] * .[1]' "$TMP" "project-$SUBTYPE/.config/variables.json" > "common-$SUBTYPE/.config/variables.json"
          fi
        done

  template:
    deps:
      - :install:npm:hbs
    cmds:
      - find . -type f -path ./common -prune -name '*.handlebars' | while read FILE; do
          hbs --data variables.json --helper @budibase/handlebars-helpers "$FILE" --stdout > "${FILE%.*}"
        done
